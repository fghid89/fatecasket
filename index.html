<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  
  <!-- FIX: Send full URL path in Referrer header to satisfy Google Cloud restrictions -->
  <meta name="referrer" content="no-referrer-when-downgrade" />
  
  <!-- PRODUCTION METADATA -->
  <title>Fate Casket ¬∑ Universal Zen Observatory</title>
  <meta name="description" content="A reflective space blending Bazi pillars with Tarot archetypes for daily guidance and spirit art generation.">
  
  <!-- Social Media Previews (Open Graph) -->
  <meta property="og:title" content="Fate Casket ¬∑ Universal Zen Observatory">
  <meta property="og:description" content="Enter the ritual. Discover your elemental balance and Tarot path.">
  <meta property="og:type" content="website">
  <meta name="twitter:card" content="summary_large_image">
  
  <!-- Favicon (Crystal Ball Emoji) -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üîÆ</text></svg>">

  <script src="https://cdn.jsdelivr.net/npm/lunar-javascript/lunar.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Noto+Serif:wght@300;400;600&display=swap');

    :root{
      --ink: #050505;
      --mist1: #1a0d1a;
      --mist2: #0c1218;
      --gold: #d4af37;
      --gold-dim: rgba(212,175,55,0.45);
      --sand: #f3e5ab;
      --ash: #afb3b8;
      --panel-bg: rgba(12, 12, 16, 0.65);
      --border-light: rgba(255, 255, 255, 0.08);
    }

    body{
      background: var(--ink);
      color: var(--ash);
      font-family: "Noto Serif", ui-serif, Georgia, serif;
      margin: 0;
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
    }

    /* --- ATMOSPHERE --- */
    .zen-mist{
      position: relative;
      min-height: 100vh;
      background:
        radial-gradient(circle at 15% 15%, rgba(212,175,55,0.04) 0%, transparent 40%),
        radial-gradient(circle at 85% 85%, rgba(100,80,180,0.06) 0%, transparent 40%),
        radial-gradient(circle at 50% 50%, var(--mist1) 0%, var(--ink) 80%);
      background-attachment: fixed;
    }

    .stars{
      pointer-events: none;
      position: absolute;
      inset: 0;
      opacity: 0.6;
      background-image:
        radial-gradient(1px 1px at 20px 30px, rgba(255,255,255,0.3), transparent),
        radial-gradient(1.5px 1.5px at 150px 80px, rgba(255,255,255,0.2), transparent),
        radial-gradient(1px 1px at 240px 220px, rgba(255,255,255,0.25), transparent);
      background-size: 350px 350px;
      animation: drift 60s linear infinite;
    }
    @keyframes drift{ from{ transform: translateY(0); } to{ transform: translateY(-350px); } }

    /* --- TYPOGRAPHY --- */
    .sigil{ font-family: "Cinzel", serif; letter-spacing: .25em; text-transform: uppercase; }
    .gold-glow{ color: var(--gold); text-shadow: 0 0 15px rgba(212,175,55,0.25); font-weight: 600; }
    
    /* --- INPUTS --- */
    select, input, textarea {
      background: rgba(8, 8, 10, 0.8) !important;
      color: var(--sand) !important;
      border: 1px solid var(--border-light) !important;
      border-radius: 12px !important;
      outline: none !important;
      transition: all 0.3s ease;
      font-family: "Noto Serif", serif;
    }
    select:focus, input:focus, textarea:focus {
      border-color: var(--gold-dim) !important;
      box-shadow: 0 0 15px rgba(212,175,55,0.05);
    }
    
    /* Custom Select Arrow */
    select {
      appearance: none;
      background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23d4af37%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
      background-repeat: no-repeat;
      background-position: right 1rem center;
      background-size: 0.65em auto;
    }

    /* --- BUTTONS --- */
    .btn-ritual{
      position: relative;
      overflow: hidden;
      border: 1px solid var(--gold-dim);
      color: var(--gold);
      transition: all .4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      letter-spacing: .25em;
      background: rgba(212,175,55,0.03);
    }
    .btn-ritual::before {
      content: "";
      position: absolute;
      top: 0; left: -100%; width: 100%; height: 100%;
      background: linear-gradient(90deg, transparent, rgba(212,175,55,0.2), transparent);
      transition: 0.5s;
    }
    .btn-ritual:hover::before { left: 100%; }
    .btn-ritual:hover{
      border-color: var(--gold);
      background: rgba(212,175,55,0.1);
      box-shadow: 0 0 25px rgba(212,175,55,0.15);
      transform: translateY(-1px);
    }
    
    .btn-ghost{
      border: 1px solid var(--border-light);
      background: rgba(255,255,255,0.02);
      color: rgba(255,255,255,0.6);
      transition: .3s;
    }
    .btn-ghost:hover{
      border-color: var(--gold-dim);
      color: var(--gold);
      background: rgba(212,175,55,0.05);
    }

    /* --- TAROT GRID --- */
    .tarot-wrapper { width: 100%; display: flex; justify-content: center; padding: 20px 0; perspective: 1000px; }
    .tarot-grid {
      display: grid;
      grid-template-columns: repeat(3, 90px);
      grid-template-rows: repeat(3, 140px);
      gap: 12px;
      margin: 0 auto;
    }
    @media (min-width: 640px){
      .tarot-grid { 
        grid-template-columns: repeat(6, 100px); 
        grid-template-rows: repeat(4, 150px); 
        gap: 16px; 
      }
      /* We will dynamically adjust columns based on deck size for a nice layout */
    }
    
    .tarot-card{ 
      position: relative; 
      width: 100%; height: 100%; 
      cursor: pointer; 
      transform-style: preserve-3d;
      transition: transform 0.1s;
    }
    .tarot-card:hover { transform: translateY(-4px); }
    
    .tarot-inner{
      position: relative; width: 100%; height: 100%;
      transition: transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      transform-style: preserve-3d;
    }
    /* FIXED: Correctly targeting the class on the element itself */
    .tarot-inner.is-flipped { transform: rotateY(180deg); }
    .is-hidden { opacity: 0; pointer-events: none; }

    .card-face{
      position: absolute; inset: 0;
      backface-visibility: hidden;
      border-radius: 8px;
      border: 1px solid rgba(212,175,55,0.2);
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0,0,0,0.5);
    }
    .card-back{
      background: 
        radial-gradient(circle at 50% 50%, rgba(20,20,25,0.9), #050505),
        url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0IiBoZWlnaHQ9IjQiPgo8cmVjdCB3aWR0aD0iNCIgaGVpZ2h0PSI0IiBmaWxsPSIjMDUwNTA1IiAvPgo8Y2lyY2xlIGN4PSIyIiBjeT0iMiIgcj0iMSIgZmlsbD0iIzIyMiIgLz4KPC9zdmc+');
      display: flex; align-items: center; justify-content: center;
      transform: rotateY(0deg);
    }
    /* Intricate back design pattern */
    .card-back::after {
      content: "";
      position: absolute; inset: 6px;
      border: 1px double rgba(212,175,55,0.3);
      border-radius: 6px;
    }
    .card-back::before {
      content: "‚ú¶";
      color: rgba(212,175,55,0.5);
      font-size: 24px;
    }

    .card-front{ 
      transform: rotateY(180deg); 
      background: #111;
      display: flex; flex-direction: column;
    }
    .card-front img { width: 100%; height: 100%; object-fit: cover; }
    
    /* VINTAGE FILTER FOR TAROT IMAGES */
    /* This simulates the look of a premium, aged deck without needing new assets */
    .vintage-filter {
      filter: sepia(0.4) contrast(1.1) brightness(0.9) saturate(0.8);
      mix-blend-mode: normal;
      transition: filter 0.5s ease;
    }
    .panel:hover .vintage-filter {
      filter: sepia(0.1) contrast(1.05) brightness(1.0) saturate(1.1); /* Reveal original colors slightly on hover */
    }

    /* --- PANELS & CHARTS --- */
    .panel{
      background: var(--panel-bg);
      border: 1px solid var(--border-light);
      box-shadow: 0 10px 40px rgba(0,0,0,0.4);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      transition: border-color 0.3s;
    }
    .panel:hover { border-color: rgba(255,255,255,0.15); }

    /* --- UTILS --- */
    .fade-in{ animation: fadeIn 1.2s cubic-bezier(0.22, 1, 0.36, 1) forwards; }
    @keyframes fadeIn{ from{ opacity:0; transform: translateY(20px);} to{opacity:1; transform: translateY(0);} }

    .switch input:checked + div { background: rgba(212,175,55,0.2); border-color: var(--gold); }
    .switch-dot { transition: transform 0.2s; }
    .switch input:checked + div .switch-dot { transform: translateX(18px); background: var(--gold); }
    
    .tip{
      border-bottom: 1px dotted rgba(212,175,55,0.5);
      cursor: help;
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #050505; }
    ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #555; }
    
    /* Journal Modal */
    .modal-backdrop {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.8);
      backdrop-filter: blur(5px);
      z-index: 100;
      display: flex; justify-content: center; align-items: center;
      opacity: 0; pointer-events: none;
      transition: opacity 0.3s;
    }
    .modal-backdrop.open { opacity: 1; pointer-events: auto; }
    .modal-content {
      background: #111;
      border: 1px solid var(--gold);
      border-radius: 20px;
      width: 90%; max-width: 500px;
      max-height: 80vh;
      overflow-y: auto;
      padding: 24px;
      box-shadow: 0 0 50px rgba(212,175,55,0.15);
      transform: translateY(20px);
      transition: transform 0.3s;
    }
    .modal-backdrop.open .modal-content { transform: translateY(0); }

    /* --- BELL ANIMATION --- */
    #bellHalo .ring-wave {
      position: absolute;
      border: 2px solid var(--gold);
      border-radius: 50%;
      opacity: 0;
      width: 50px; height: 50px;
      animation: ripple 1.5s ease-out;
    }
    @keyframes ripple {
      0% { opacity: 0.8; transform: scale(1); border-width: 4px; }
      100% { opacity: 0; transform: scale(4); border-width: 0px; }
    }
  </style>
</head>

<body class="zen-mist">
  <div class="stars"></div>
  
  <!-- Bell Visual Effect Container -->
  <div id="bellHalo" class="fixed inset-0 pointer-events-none flex items-center justify-center z-50"></div>

  <!-- Toast Container -->
  <div id="toastContainer" class="fixed bottom-6 left-1/2 -translate-x-1/2 z-50 flex flex-col items-center gap-2 w-full max-w-sm px-4 pointer-events-none"></div>

  <!-- Journal Modal -->
  <div id="journalModal" class="modal-backdrop" onclick="if(event.target===this) toggleJournal()">
    <div class="modal-content">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-gold text-xl sigil">Past Rituals</h2>
        <button onclick="toggleJournal()" class="text-gray-500 hover:text-white">&times;</button>
      </div>
      <div id="journalList" class="space-y-4">
        <!-- History items go here -->
      </div>
      <button onclick="clearJournal()" class="mt-6 w-full py-2 border border-white/10 rounded-lg text-[10px] uppercase text-gray-500 hover:bg-red-900/20 hover:text-red-400 transition">Clear History</button>
    </div>
  </div>

  <div class="max-w-6xl mx-auto px-4 sm:px-6 py-12 relative z-10">
    
    <!-- HEADER -->
    <header class="text-center mb-16 space-y-5 fade-in relative">
      <button onclick="toggleJournal()" class="absolute right-0 top-0 sm:right-4 sm:top-4 text-gold/60 hover:text-gold transition flex flex-col items-center gap-1 group">
        <span class="text-2xl group-hover:scale-110 transition">üìú</span>
        <span class="text-[9px] uppercase tracking-widest">Journal</span>
      </button>

      <h1 class="text-4xl sm:text-6xl gold-glow tracking-widest" style="font-family: Cinzel, serif;">FATE CASKET</h1>
      <div class="flex items-center justify-center gap-3 opacity-60">
        <span class="h-px w-8 bg-gold"></span>
        <p class="sigil text-[10px] sm:text-[11px] text-yellow-100/70">Universal Zen Observatory</p>
        <span class="h-px w-8 bg-gold"></span>
      </div>
      <p class="text-gray-500 text-xs leading-relaxed max-w-lg mx-auto font-light italic">
        "To see clearly is to stop adding stories." <br>
        A reflective space blending Bazi pillars with Tarot archetypes.
      </p>
    </header>

    <!-- INPUT STAGE -->
    <section id="inputStage" class="fade-in max-w-xl mx-auto panel p-8 sm:p-10 rounded-3xl relative overflow-hidden">
      <!-- Decorative corner accents -->
      <div class="absolute top-0 left-0 w-16 h-16 border-t border-l border-white/10 rounded-tl-3xl pointer-events-none"></div>
      <div class="absolute bottom-0 right-0 w-16 h-16 border-b border-r border-white/10 rounded-br-3xl pointer-events-none"></div>

      <div class="space-y-8">
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
          <div class="space-y-2">
            <label class="text-[10px] uppercase tracking-widest text-gray-500 font-bold ml-1">Birth Date</label>
            <input type="date" id="birthDate" class="w-full p-3.5" />
          </div>

          <div class="space-y-2">
            <label class="text-[10px] uppercase tracking-widest text-gray-500 font-bold ml-1">Essence</label>
            <select id="gender" class="w-full p-3.5 cursor-pointer">
              <option value="1">Yang (Action/Expansion)</option>
              <option value="0">Yin (Stillness/Nurturing)</option>
            </select>
          </div>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
          <div class="space-y-2">
            <label class="text-[10px] uppercase tracking-widest text-gray-500 font-bold ml-1">Birth Hour</label>
            <select id="birthTime" class="w-full p-3.5 cursor-pointer">
              <option value="0">Zi (23:00‚Äì01:00) ¬∑ Rat</option>
              <option value="2">Chou (01:00‚Äì03:00) ¬∑ Ox</option>
              <option value="4">Yin (03:00‚Äì05:00) ¬∑ Tiger</option>
              <option value="6">Mao (05:00‚Äì07:00) ¬∑ Rabbit</option>
              <option value="8">Chen (07:00‚Äì09:00) ¬∑ Dragon</option>
              <option value="10">Si (09:00‚Äì11:00) ¬∑ Snake</option>
              <option value="12">Wu (11:00‚Äì13:00) ¬∑ Horse</option>
              <option value="14">Wei (13:00‚Äì15:00) ¬∑ Goat</option>
              <option value="16">Shen (15:00‚Äì17:00) ¬∑ Monkey</option>
              <option value="18">You (17:00‚Äì19:00) ¬∑ Rooster</option>
              <option value="20">Xu (19:00‚Äì21:00) ¬∑ Dog</option>
              <option value="22">Hai (21:00‚Äì23:00) ¬∑ Pig</option>
            </select>
          </div>

          <div class="space-y-2">
            <label class="text-[10px] uppercase tracking-widest text-gray-500 font-bold ml-1">Intent (Focus)</label>
            <input type="text" id="intent" class="w-full p-3.5" placeholder="e.g. clarity, transition, peace" maxlength="40" />
          </div>
        </div>

        <div class="pt-4 flex flex-col sm:flex-row items-center justify-between gap-6 border-t border-white/5">
          <label class="switch flex items-center gap-3 cursor-pointer group">
            <input type="checkbox" id="buddhistMode" class="hidden" checked />
            <div class="w-10 h-6 bg-white/5 rounded-full border border-white/10 relative p-0.5 transition-colors group-hover:border-gold/50">
              <div class="switch-dot w-4 h-4 bg-gray-400 rounded-full shadow-sm"></div>
            </div>
            <div class="text-xs text-gray-400 group-hover:text-gray-300 transition">
              <span class="block font-semibold">Zen Mode</span>
              <span class="text-[10px] opacity-70">Adds GƒÅthƒÅ & Metta</span>
            </div>
          </label>

          <div class="flex gap-3 w-full sm:w-auto">
            <button class="btn-ghost flex-1 sm:flex-none px-5 py-3 rounded-xl text-[10px] tracking-widest uppercase font-semibold" onclick="ringBell()">
              Bell
            </button>
            <button onclick="startOracle()" class="btn-ritual flex-1 sm:flex-none px-8 py-3 rounded-xl text-[10px] uppercase font-bold tracking-[0.25em]">
              Enter Ritual
            </button>
          </div>
        </div>
      </div>
    </section>

    <!-- TAROT STAGE -->
    <section id="tarotStage" class="hidden space-y-12 fade-in text-center mt-8 pb-20">
      <div class="space-y-3">
        <p id="vibeHeader" class="text-[#d4af37] text-2xl sm:text-3xl sigil tracking-widest"></p>
        <p id="ritualLine" class="text-gray-500 text-xs tracking-[0.2em] uppercase opacity-80 animate-pulse">Shuffle... Clear your mind.</p>
      </div>

      <div class="tarot-wrapper">
        <div id="deck" class="tarot-grid" role="list" aria-label="Tarot Deck Selection"></div>
      </div>

      <div class="space-y-2">
        <p class="text-[10px] text-gray-500 uppercase tracking-widest">
          Chosen: <span id="pCount" class="text-[#d4af37] font-bold text-lg mx-1">0</span> / 3
        </p>
        <div class="flex justify-center gap-4 text-[10px] text-gray-600 uppercase tracking-wider font-bold">
          <span class="flex items-center gap-1"><span class="w-1.5 h-1.5 rounded-full bg-gray-600"></span> Mirror</span>
          <span class="flex items-center gap-1"><span class="w-1.5 h-1.5 rounded-full bg-gray-600"></span> Key</span>
          <span class="flex items-center gap-1"><span class="w-1.5 h-1.5 rounded-full bg-gray-600"></span> Gate</span>
        </div>
      </div>
    </section>

    <!-- RESULT STAGE -->
    <section id="resultStage" class="hidden space-y-12 fade-in pb-32 mt-8">
      
      <!-- Charts Section -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Elemental Radar -->
        <div class="panel p-6 sm:p-10 rounded-3xl flex flex-col items-center">
          <h4 class="text-[10px] uppercase tracking-[0.2em] text-gray-500 mb-6 font-bold">Elemental Balance</h4>
          <div id="radarChart" class="w-full max-w-[300px] aspect-square flex items-center justify-center"></div>
          <div id="elementLegend" class="flex flex-wrap justify-center gap-x-6 gap-y-2 mt-6 text-[10px] text-gray-400 uppercase font-bold tracking-wider w-full"></div>
        </div>

        <!-- Metrics & Trend -->
        <div class="panel p-6 sm:p-10 rounded-3xl flex flex-col justify-between gap-8">
          
          <!-- Yin Yang -->
          <div class="space-y-4">
            <h4 class="text-[10px] uppercase tracking-[0.2em] text-gray-500 text-center font-bold">Yin‚ÄìYang Flux</h4>
            <div class="relative pt-6 px-4">
              <div class="h-1.5 w-full bg-white/10 rounded-full overflow-hidden">
                <div class="h-full w-full bg-gradient-to-r from-blue-900 via-gray-500 to-yellow-700 opacity-30"></div>
              </div>
              <div id="yyPointer" class="absolute top-3 left-1/2 -translate-x-1/2 transition-all duration-1000">
                 <div class="w-0 h-0 border-l-[6px] border-l-transparent border-r-[6px] border-r-transparent border-t-[8px] border-t-gold"></div>
              </div>
              <div class="flex justify-between text-[9px] mt-3 font-bold uppercase tracking-widest opacity-60">
                <span>Inward</span>
                <span>Balanced</span>
                <span>Outward</span>
              </div>
            </div>
            <p id="yyHint" class="text-xs text-center text-gray-400 font-light"></p>
          </div>

          <!-- Time Trend -->
          <div class="space-y-4">
            <h4 class="text-[10px] uppercase tracking-[0.2em] text-gray-500 text-center font-bold">Daily Cycle Momentum</h4>
            <div id="trendChart" class="flex items-end justify-between h-24 gap-1 px-2"></div>
            <div class="flex justify-between text-[9px] text-gray-600 px-2 uppercase font-bold">
              <span>Night</span><span>Noon</span><span>Night</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Breath & Zen -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Breathwork -->
        <div class="panel p-8 rounded-3xl text-center">
          <h4 class="text-[10px] uppercase tracking-[0.2em] text-gray-500 font-bold mb-6">Anchor Ritual</h4>
          <div class="flex items-center justify-center mb-6">
            <div id="breathOrb" class="w-32 h-32 rounded-full border border-gold/20 flex items-center justify-center transition-all duration-1000">
               <div class="text-center">
                 <div id="breathPhase" class="text-gold font-bold tracking-widest text-xs">READY</div>
                 <div id="breathCount" class="text-gray-500 text-xs mt-1 font-mono opacity-50">‚Äî</div>
               </div>
            </div>
          </div>
          <div class="flex justify-center gap-3">
             <button class="btn-ghost px-4 py-2 rounded-lg text-[10px] uppercase font-bold" onclick="startBreath()">Start Cycle</button>
             <button class="btn-ghost px-4 py-2 rounded-lg text-[10px] uppercase font-bold text-red-400/70 hover:text-red-400" onclick="stopBreath()">Stop</button>
          </div>
          <p class="text-[10px] text-gray-600 mt-4 italic">Inhale (4) ¬∑ Hold (2) ¬∑ Exhale (6)</p>
        </div>

        <!-- Zen Quote -->
        <div class="panel p-8 rounded-3xl flex flex-col justify-center text-center">
          <div class="sigil text-4xl text-white/10 mb-4">‚ò∏</div>
          <p id="zenGatha" class="text-lg text-gray-300 font-serif italic leading-relaxed mb-4"></p>
          <div id="zenExtras" class="text-xs text-gray-500 leading-7"></div>
        </div>
      </div>

      <!-- Final Cards -->
      <div class="space-y-6">
         <div class="flex items-center justify-center gap-4 opacity-50 mb-4">
            <span class="h-px w-12 bg-gold"></span>
            <span class="text-[10px] uppercase tracking-[0.3em] text-gold">The Path</span>
            <span class="h-px w-12 bg-gold"></span>
         </div>
         <div id="finalCards" class="grid grid-cols-1 md:grid-cols-3 gap-6 max-w-5xl mx-auto"></div>
      </div>

      <!-- Analysis Report -->
      <div class="panel p-8 sm:p-12 rounded-[2rem] border border-gold/10 relative">
        <div class="absolute -top-3 left-1/2 -translate-x-1/2 px-4 py-1 bg-[#0c0c10] border border-gold/30 rounded-full text-gold sigil text-[10px] tracking-widest shadow-lg">
          Awareness Report
        </div>
        <div id="fullAnalysis" class="text-gray-300 leading-loose text-left space-y-8 text-sm sm:text-[15px] pt-4 font-light"></div>
        
        <!-- STEP 1: Generate Art -->
        <div class="mt-8 flex justify-center">
            <button id="btnGenArt" onclick="generateArt()" class="btn-ritual px-8 py-4 rounded-xl text-xs uppercase tracking-widest flex items-center justify-center gap-2 w-full sm:w-auto hover:scale-105 transition-transform">
              <span>‚ú¶ Generate Spirit Art</span>
            </button>
        </div>

        <!-- Generated Image Container -->
        <div id="artContainer" class="hidden mt-8 text-center fade-in space-y-4">
          <h4 class="text-gold font-serif text-sm tracking-widest">Vision from the Deep</h4>
          <div class="relative w-full max-w-md mx-auto aspect-square rounded-xl overflow-hidden shadow-2xl border border-gold/20 group">
            <img id="generatedArt" class="w-full h-full object-cover">
            <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center text-[10px] text-white tracking-widest pointer-events-none">
                Long press to save
            </div>
          </div>
          <p class="text-[10px] text-gray-500 italic">Generated by AI based on your element and cards.</p>
        </div>

        <!-- STEP 2: Share (Now located AFTER art) -->
        <div class="mt-8 pt-8 border-t border-white/5 flex justify-center">
            <button onclick="shareReading()" class="btn-ghost px-8 py-4 rounded-xl text-xs uppercase tracking-widest flex items-center justify-center gap-3 hover:bg-gold/10 hover:text-gold transition w-full sm:w-auto border-gold/30 text-gold/80">
              <span class="text-lg">‚ú®</span>
              <span>Copy X Post</span>
            </button>
        </div>
      </div>

      <div class="flex items-center justify-center gap-6 pb-8">
        <button onclick="updateKey()" class="text-gray-700 hover:text-gray-500 text-[9px] uppercase tracking-widest transition">
          API Key
        </button>
        <button onclick="location.reload()" class="py-4 px-8 text-gray-600 hover:text-gold transition-colors duration-500 text-[10px] tracking-[0.5em] uppercase border-b border-transparent hover:border-gold/30">
          Empty Cup ¬∑ Begin Again
        </button>
      </div>

    </section>
  </div>

  <script>
    let apiKey = "AIzaSyD8TQgJkhppAkZs38vYiwse2Teuoz5Zjdw"; // Optional: Paste your API key here, or leave empty to be prompted at runtime.
    
    function updateKey() {
        const newKey = prompt("Enter new Google API Key:", apiKey);
        if(newKey && newKey.trim() !== "") {
            apiKey = newKey.trim();
            toast("Key updated for this session.", "gold");
        }
    }

    // --- UTILITIES ---
    function toast(msg, type="neutral") {
      const container = document.getElementById("toastContainer");
      if(!container) return;
      
      const t = document.createElement("div");
      // Added max-w-xs to prevent super long error messages from looking weird
      t.className = "fade-in bg-[#15151a] border border-gold/30 text-gray-300 px-4 py-3 rounded-xl shadow-2xl text-xs flex items-center gap-3 backdrop-blur-md pointer-events-auto max-w-sm text-left break-words";
      
      // Color coding for error/success
      let icon = "‚ú¶";
      if(type === "error") { 
          icon = "‚ö†Ô∏è"; 
          t.style.borderColor = "rgba(255,100,100,0.3)"; 
          t.classList.add("text-red-200");
      }
      
      t.innerHTML = `<span class="text-gold text-lg">${icon}</span> <span>${msg}</span>`;
      
      container.appendChild(t);
      // Increased timeout for errors so user can read them
      const duration = type === "error" ? 8000 : 3000;
      
      setTimeout(() => { 
        t.style.opacity = "0"; 
        t.style.transform = "translateY(10px)";
        t.style.transition = "all 0.5s ease";
        setTimeout(() => t.remove(), 500); 
      }, duration);
    }

    // --- DATA ---
    const ZODIAC_RULES = [
      {n:"Capricorn",m:1,d:20},{n:"Aquarius",m:2,d:19},{n:"Pisces",m:3,d:21},{n:"Aries",m:4,d:20},
      {n:"Taurus",m:5,d:21},{n:"Gemini",m:6,d:22},{n:"Cancer",m:7,d:23},{n:"Leo",m:8,d:23},
      {n:"Virgo",m:9,d:23},{n:"Libra",m:10,d:24},{n:"Scorpio",m:11,d:23},{n:"Sagittarius",m:12,d:22}
    ];

    const GAN_MAP = {'Áî≤':'Wood','‰πô':'Wood','‰∏ô':'Fire','‰∏Å':'Fire','Êàä':'Earth','Â∑±':'Earth','Â∫ö':'Metal','Ëæõ':'Metal','Â£¨':'Water','Áô∏':'Water'};
    const ELEMENTS = ['Wood','Fire','Earth','Metal','Water'];
    
    // Expanded Zen Tarot (Full Major Arcana)
    const TAROT_FULL = [
      { n: "The Fool", key: "Beginner's Mind", zen: "Step without knowing where the foot will land.", img: "https://www.sacred-texts.com/tarot/pkt/img/ar00.jpg" },
      { n: "The Magician", key: "Presence", zen: "One intention, one action. Magic is focus.", img: "https://www.sacred-texts.com/tarot/pkt/img/ar01.jpg" },
      { n: "The High Priestess", key: "Intuition", zen: "Silence speaks louder than logic.", img: "https://www.sacred-texts.com/tarot/pkt/img/ar02.jpg" },
      { n: "The Empress", key: "Nurturing", zen: "Allow things to grow in their own time.", img: "https://www.sacred-texts.com/tarot/pkt/img/ar03.jpg" },
      { n: "The Emperor", key: "Structure", zen: "Discipline is the container for freedom.", img: "https://www.sacred-texts.com/tarot/pkt/img/ar04.jpg" },
      { n: "The Hierophant", key: "Tradition", zen: "Learn the form to eventually break the form.", img: "https://www.sacred-texts.com/tarot/pkt/img/ar05.jpg" },
      { n: "The Lovers", key: "Union", zen: "Choice defines you. Harmony requires two notes.", img: "https://www.sacred-texts.com/tarot/pkt/img/ar06.jpg" },
      { n: "The Chariot", key: "Willpower", zen: "Direction matters more than speed.", img: "https://www.sacred-texts.com/tarot/pkt/img/ar07.jpg" },
      { n: "Strength", key: "Gentleness", zen: "Soft water hollows out hard stone.", img: "https://www.sacred-texts.com/tarot/pkt/img/ar08.jpg" },
      { n: "The Hermit", key: "Solitude", zen: "Withdraw to see clearly. The lamp is within.", img: "https://www.sacred-texts.com/tarot/pkt/img/ar09.jpg" },
      { n: "Wheel of Fortune", key: "Cycles", zen: "This too shall pass. Ride the turn.", img: "https://www.sacred-texts.com/tarot/pkt/img/ar10.jpg" },
      { n: "Justice", key: "Balance", zen: "Every action has its echo. Be fair to yourself.", img: "https://www.sacred-texts.com/tarot/pkt/img/ar11.jpg" },
      { n: "The Hanged Man", key: "Surrender", zen: "Pause is not stopping. Perspective shifts everything.", img: "https://www.sacred-texts.com/tarot/pkt/img/ar12.jpg" },
      { n: "Death", key: "Release", zen: "Let the dead leaves fall so spring can come.", img: "https://www.sacred-texts.com/tarot/pkt/img/ar13.jpg" },
      { n: "Temperance", key: "Moderation", zen: "The middle path sustains the longest journey.", img: "https://www.sacred-texts.com/tarot/pkt/img/ar14.jpg" },
      { n: "The Devil", key: "Attachment", zen: "Name your chains and they begin to dissolve.", img: "https://www.sacred-texts.com/tarot/pkt/img/ar15.jpg" },
      { n: "The Tower", key: "Upheaval", zen: "Destruction clears the ground for truth.", img: "https://www.sacred-texts.com/tarot/pkt/img/ar16.jpg" },
      { n: "The Star", key: "Hope", zen: "In the darkest dark, the light is most distinct.", img: "https://www.sacred-texts.com/tarot/pkt/img/ar17.jpg" },
      { n: "The Moon", key: "Illusion", zen: "Fear is just a shadow. Walk through the mist.", img: "https://www.sacred-texts.com/tarot/pkt/img/ar18.jpg" },
      { n: "The Sun", key: "Vitality", zen: "Transparency reveals the way. Shine without apology.", img: "https://www.sacred-texts.com/tarot/pkt/img/ar19.jpg" },
      { n: "Judgement", key: "Awakening", zen: "Hear the call. Rise up to your own life.", img: "https://www.sacred-texts.com/tarot/pkt/img/ar20.jpg" },
      { n: "The World", key: "Integration", zen: "The circle is complete. Everything belongs.", img: "https://www.sacred-texts.com/tarot/pkt/img/ar21.jpg" }
    ];

    // Bazi Data
    const ZHI_HIDDEN = {
      'Â≠ê': [{'gan':'Áô∏','w':1.0}], '‰∏ë': [{'gan':'Â∑±','w':0.60},{'gan':'Áô∏','w':0.30},{'gan':'Ëæõ','w':0.10}],
      'ÂØÖ': [{'gan':'Áî≤','w':0.60},{'gan':'‰∏ô','w':0.20},{'gan':'Êàä','w':0.20}], 'ÂçØ': [{'gan':'‰πô','w':1.0}],
      'Ëæ∞': [{'gan':'Êàä','w':0.60},{'gan':'‰πô','w':0.20},{'gan':'Áô∏','w':0.20}], 'Â∑≥': [{'gan':'‰∏ô','w':0.60},{'gan':'Â∫ö','w':0.20},{'gan':'Êàä','w':0.20}],
      'Âçà': [{'gan':'‰∏Å','w':0.70},{'gan':'Â∑±','w':0.30}], 'Êú™': [{'gan':'Â∑±','w':0.60},{'gan':'‰πô','w':0.20},{'gan':'‰∏Å','w':0.20}],
      'Áî≥': [{'gan':'Â∫ö','w':0.60},{'gan':'Â£¨','w':0.20},{'gan':'Êàä','w':0.20}], 'ÈÖâ': [{'gan':'Ëæõ','w':1.0}],
      'Êàå': [{'gan':'Êàä','w':0.60},{'gan':'Ëæõ','w':0.20},{'gan':'‰∏Å','w':0.20}], '‰∫•': [{'gan':'Â£¨','w':0.70},{'gan':'Áî≤','w':0.30}]
    };
    const SEASON_QI = {
      'Spring': {Wood:0.50, Fire:0.20, Earth:0.20, Metal:0.05, Water:0.05},
      'Summer': {Fire:0.50, Earth:0.20, Wood:0.20, Water:0.05, Metal:0.05},
      'Autumn': {Metal:0.50, Water:0.20, Earth:0.20, Wood:0.05, Fire:0.05},
      'Winter': {Water:0.50, Wood:0.20, Metal:0.20, Fire:0.05, Earth:0.05}
    };
    const SEASON_BY_ZHI = { 'ÂØÖ':'Spring','ÂçØ':'Spring','Ëæ∞':'Spring', 'Â∑≥':'Summer','Âçà':'Summer','Êú™':'Summer', 'Áî≥':'Autumn','ÈÖâ':'Autumn','Êàå':'Autumn', '‰∫•':'Winter','Â≠ê':'Winter','‰∏ë':'Winter' };
    
    // State
    let state = {
      picked: [],
      wuxing: null,
      buddhistMode: true,
      masterElem: "Wood"
    };

    // --- LOGIC ---
    function startOracle(){
      if(typeof Solar === "undefined"){
        toast("Library loading... check internet connection.");
        return;
      }
      
      const bDate = document.getElementById("birthDate").value;
      if(!bDate) { toast("Please enter your birth date."); return; }
      
      const parts = bDate.split("-").map(Number);
      const h = parseInt(document.getElementById("birthTime").value, 10);
      
      state.buddhistMode = document.getElementById("buddhistMode").checked;
      
      // Calculate Bazi
      const solarBirth = Solar.fromYmdHms(parts[0], parts[1], parts[2], h, 0, 0);
      const ec = solarBirth.getLunar().getEightChar();
      state.ec = ec;
      state.master = ec.getDayGan();
      state.masterElem = GAN_MAP[state.master];
      
      // Zodiac
      const zIdx = ZODIAC_RULES.findIndex(x => parts[1] < x.m || (parts[1] === x.m && parts[2] < x.d));
      state.zodiac = (zIdx === -1) ? "Capricorn" : ZODIAC_RULES[zIdx].n;
      
      // Elements
      calcWuXing(ec);
      
      // Transition UI
      document.getElementById("inputStage").classList.add("hidden");
      const stage = document.getElementById("tarotStage");
      stage.classList.remove("hidden");
      
      document.getElementById("vibeHeader").innerHTML = `
        <span class="text-sm opacity-60 block mb-1 font-sans tracking-normal">Ritual for</span>
        ${state.zodiac} ¬∑ ${state.masterElem} Day Master
      `;
      
      document.getElementById("ritualLine").innerText = state.buddhistMode 
        ? "Breathe in stillness. The cards are mirrors."
        : "Focus your intent. Select three archetypes.";

      initDeck();
    }

    function calcWuXing(ec){
      const pillars = [
        {g:ec.getYearGan(), z:ec.getYearZhi()},
        {g:ec.getMonthGan(), z:ec.getMonthZhi()},
        {g:ec.getDayGan(), z:ec.getDayZhi()},
        {g:ec.getTimeGan(), z:ec.getTimeZhi()}
      ];
      
      let scores = {Wood:0, Fire:0, Earth:0, Metal:0, Water:0};
      const monthZhi = ec.getMonthZhi();
      const season = SEASON_BY_ZHI[monthZhi] || 'Spring';
      
      // Base calculation
      pillars.forEach((p, i) => {
        // Heavenly Stem
        scores[GAN_MAP[p.g]] += (i===1 ? 1.2 : 1.0); // Month stem heavier
        
        // Earthly Branch (Hidden Stems)
        const hidden = ZHI_HIDDEN[p.z] || [];
        hidden.forEach(h => {
           scores[GAN_MAP[h.gan]] += h.w * (i===1 ? 1.3 : 1.1);
        });
      });
      
      // Season adjustment
      const qi = SEASON_QI[season];
      for(let e in qi) scores[e] += qi[e] * 1.5;
      
      // Convert to %
      const total = Object.values(scores).reduce((a,b)=>a+b,0);
      state.wuxing = {};
      for(let e in scores) state.wuxing[e] = (scores[e] / total) * 100;
    }

    function initDeck(){
      const deck = document.getElementById("deck");
      deck.innerHTML = "";
      state.picked = [];
      document.getElementById("pCount").innerText = "0";

      // Full shuffle of 22 cards
      const shuffled = [...TAROT_FULL].sort(() => Math.random() - 0.5);
      
      // Responsive layout adjustment
      const isMobile = window.innerWidth < 640;
      const displayCount = isMobile ? 12 : 22; // Show fewer on mobile to avoid scrolling fatigue? Actually let's show all but maybe smaller.
      
      // We will render all 22 cards.
      shuffled.forEach((card, i) => {
        const el = document.createElement("div");
        el.className = "tarot-card fade-in";
        el.style.animationDelay = `${i * 30}ms`;
        el.setAttribute("role", "button");
        el.setAttribute("tabindex", "0");
        el.setAttribute("aria-label", "Select tarot card " + (i+1));
        
        // Handling keyboard selection
        el.addEventListener("keydown", (e) => {
          if(e.key === "Enter" || e.key === " ") handlePick(el.querySelector('.tarot-inner'));
        });

        const glyph = state.buddhistMode ? "‚ò∏" : "‚ú¶";
        
        el.innerHTML = `
          <div class="tarot-inner" onclick="handlePick(this)">
            <div class="card-face card-back"></div>
            <div class="card-face card-front">
              <img src="${card.img}" alt="${card.n}" loading="lazy" class="vintage-filter">
            </div>
          </div>
        `;
        el.dataset.card = JSON.stringify(card);
        deck.appendChild(el);
      });
    }

    function handlePick(inner){
      if(inner.classList.contains("is-flipped") || state.picked.length >= 3) return;
      
      ringBell(0.1); // subtle click sound
      inner.classList.add("is-flipped");
      
      const cardData = JSON.parse(inner.parentElement.dataset.card);
      state.picked.push(cardData);
      
      document.getElementById("pCount").innerText = state.picked.length;
      
      if(state.picked.length === 3){
         toast("Path Selected. Revealing...", "gold");
         setTimeout(renderFinal, 1200);
      }
    }

    // --- BAZI RELATIONSHIPS (Ten Gods simplified) ---
    function getRelation(me, el) {
      const idxMe = ELEMENTS.indexOf(me);
      const idxEl = ELEMENTS.indexOf(el);
      const diff = (idxEl - idxMe + 5) % 5;
      
      // 0=Same, 1=Output, 2=Wealth, 3=Power, 4=Resource
      const labels = ["Self/Companion", "Output/Expression", "Wealth/Control", "Power/Discipline", "Resource/Support"];
      return labels[diff];
    }

    function renderFinal(){
      document.getElementById("tarotStage").classList.add("hidden");
      document.getElementById("resultStage").classList.remove("hidden");
      window.scrollTo({top:0, behavior:'smooth'});
      
      renderRadar();
      renderTrend();
      renderResults();
      
      // Generate Analysis Text
      const [c1, c2, c3] = state.picked;
      const strongest = Object.entries(state.wuxing).sort((a,b)=>b[1]-a[1])[0][0];
      const weakest = Object.entries(state.wuxing).sort((a,b)=>a[1]-b[1])[0][0];
      
      const strongRel = getRelation(state.masterElem, strongest);
      const weakRel = getRelation(state.masterElem, weakest);

      const intent = document.getElementById("intent").value.trim();
      const theme = intent ? `Regarding "${intent}"` : "The current energy";
      
      const advice = {
        'Wood': 'focus on growth and flexibility',
        'Fire': 'express joy but avoid burnout',
        'Earth': 'seek stability and trust',
        'Metal': 'refine your boundaries',
        'Water': 'rest and reflect deeply'
      };

      const html = `
        <div class="space-y-6">
          <div class="border-b border-white/10 pb-4">
             <h3 class="text-gold text-lg font-serif mb-2">Core Theme</h3>
             <p>${theme}, the path opens with <strong>${c1.n}</strong>, challenging you to look at ${c1.key.toLowerCase()}. 
             The key to movement lies in <strong>${c2.n}</strong> (${c2.key}), leading eventually to <strong>${c3.n}</strong>.</p>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
             <div class="bg-white/5 p-4 rounded-xl">
               <h4 class="text-xs uppercase tracking-widest text-gray-500 mb-2">Elemental Balance</h4>
               <p>Your chart is dominated by <span class="text-gold">${strongest}</span> (${strongRel}). 
               Lowest energy is ${weakest} (${weakRel}). To balance, ${advice[weakest]}.</p>
             </div>
             
             <div class="bg-white/5 p-4 rounded-xl">
               <h4 class="text-xs uppercase tracking-widest text-gray-500 mb-2">Actionable Zen</h4>
               <p>${c2.zen} Do not overthink. Just take the step suggested by ${c2.n}.</p>
             </div>
          </div>
          
          <div class="text-xs text-gray-500 italic pt-2">
            "We do not read the cards to predict the future, but to create it."
          </div>
        </div>
      `;
      document.getElementById("fullAnalysis").innerHTML = html;
      
      // Zen Gatha
      const gathas = [
        "Breathing in, I calm my body. Breathing out, I smile.",
        "The present moment is the only moment available to us.",
        "Let go of how you think life should be.",
        "Your mind is a garden. Your thoughts are the seeds."
      ];
      document.getElementById("zenGatha").innerText = state.buddhistMode 
        ? gathas[Math.floor(Math.random()*gathas.length)]
        : "Trust the silence between your thoughts.";
        
      document.getElementById("zenExtras").innerHTML = `
        Reflect on <strong>${c1.n}</strong> as your Mirror.<br>
        Use <strong>${c2.n}</strong> as your Key.<br>
        Walk towards <strong>${c3.n}</strong> as your Gate.
      `;

      // Save to Journal
      saveToJournal({
         date: new Date().toLocaleDateString(),
         cards: [c1.n, c2.n, c3.n],
         intent: intent || "General Reading",
         strongest: `${strongest} (${strongRel})`
      });
    }

    // --- JOURNAL SYSTEM ---
    function getJournal() {
      try {
        return JSON.parse(localStorage.getItem('fate_journal')) || [];
      } catch(e) { return []; }
    }
    
    function saveToJournal(entry) {
      const hist = getJournal();
      hist.unshift(entry);
      if(hist.length > 20) hist.pop(); // Keep last 20
      localStorage.setItem('fate_journal', JSON.stringify(hist));
    }
    
    function toggleJournal() {
      const modal = document.getElementById('journalModal');
      const isOpen = modal.classList.contains('open');
      
      if(!isOpen) {
        const list = document.getElementById('journalList');
        const hist = getJournal();
        if(hist.length === 0) {
          list.innerHTML = '<div class="text-gray-500 text-center text-sm">No rituals recorded yet.</div>';
        } else {
          list.innerHTML = hist.map(h => `
            <div class="bg-white/5 p-3 rounded-lg border border-white/5">
              <div class="flex justify-between text-[10px] text-gold uppercase tracking-widest mb-1">
                <span>${h.date}</span>
                <span>${h.intent}</span>
              </div>
              <div class="text-gray-300 text-sm font-serif">
                ${h.cards.join(" ‚Üí ")}
              </div>
              <div class="text-gray-500 text-[10px] mt-1">Focus: ${h.strongest}</div>
            </div>
          `).join('');
        }
        modal.classList.add('open');
      } else {
        modal.classList.remove('open');
      }
    }
    
    function clearJournal() {
      if(confirm("Clear your ritual history?")) {
        localStorage.removeItem('fate_journal');
        toggleJournal(); // Refresh
      }
    }
    
    // --- HELPER: Base64 to File ---
    function dataURLtoFile(dataurl, filename) {
        let arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1],
            bstr = atob(arr[1]), n = bstr.length, u8arr = new Uint8Array(n);
        while(n--){
            u8arr[n] = bstr.charCodeAt(n);
        }
        return new File([u8arr], filename, {type:mime});
    }

    // --- SHARE SYSTEM (Text Only) ---
    async function shareReading() {
      const btn = document.querySelector("button[onclick='shareReading()']");
      const originalContent = btn.innerHTML;
      
      // 1. Gather Data
      const [c1, c2, c3] = state.picked;
      
      // FIX: Changed default from "General Reading" to "The Open Path" to prevent "G.R." abbreviation
      let intent = document.getElementById("intent").value.trim();
      if (!intent) intent = "The Open Path";

      // Safe access to strongest element
      const strongest = state.wuxing 
        ? Object.entries(state.wuxing).sort((a,b)=>b[1]-a[1])[0][0] 
        : "Mystery";
      const displayedQuote = document.getElementById("zenGatha").innerText;

      // 2. Define Default Template
      const fallbackText = `‚ú® FATE CASKET RITUAL\n\n` +
        `Focus: ${intent}\n` +
        `Element: ${strongest}\n` +
        `Path: ${c1.n} -> ${c2.n} -> ${c3.n}\n\n` +
        `"${displayedQuote}"\n\n` +
        `#FateCasket #Tarot #Zen`;

      btn.disabled = true;
      btn.innerHTML = `<span class="animate-spin">‚ò∏</span> Drafting Post...`;

      // 3. Generate Caption via AI
      let shareText = fallbackText;
      if(apiKey && apiKey.length > 10) {
        try {
          const prompt = `Write a deep, mystical X post (STRICTLY UNDER 280 chars) for a Tarot reading.
          
          Context:
          - Focus: "${intent}"
          - Element: ${strongest}
          - Cards: ${c1.n}, ${c2.n}, ${c3.n}
          - Wisdom: "${displayedQuote}"
          
          Constraint: Synthesize these into a single poetic thought.
          Tone: Zen, enigmatic, beautiful.
          Add hashtags #FateCasket.
          CRITICAL: The output MUST be less than 280 characters.
          CRITICAL: Do not use abbreviations like "(G.R.)". Weave the intent naturally into the text.`;

          const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
          });

          const data = await response.json();
          if(data.candidates && data.candidates[0].content.parts[0].text) {
             shareText = data.candidates[0].content.parts[0].text.trim();
          }
        } catch(e) {
          console.error("Caption Error:", e);
        }
      }

      // 4. Copy to Clipboard
      try {
        await navigator.clipboard.writeText(shareText);
        toast("Post copied! Ready for X.", "gold");
      } catch (err) {
        console.error("Clipboard failed:", err);
        toast("Could not copy text.", "error");
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalContent;
      }
    }

    // --- ART GENERATION ---
    async function generateArt() {
      const btn = document.getElementById("btnGenArt");
      const container = document.getElementById("artContainer");
      const img = document.getElementById("generatedArt");
      
      // Determine API Key
      let currentKey = apiKey;
      if(!currentKey) {
        currentKey = prompt("Please enter your Google Gemini API Key to generate Spirit Art:");
        if(!currentKey) {
            toast("Generation canceled.", "neutral");
            return;
        }
      }
      
      currentKey = currentKey.trim(); // SAFETY: Remove accidental whitespace

      // Loading UI
      btn.disabled = true;
      btn.innerHTML = `<span class="animate-spin">‚ò∏</span> Dreaming...`;
      
      // Context
      const strongest = Object.entries(state.wuxing).sort((a,b)=>b[1]-a[1])[0][0];
      const [c1, c2, c3] = state.picked;
      const intent = document.getElementById("intent").value || "Life Path";
      
      // Elemental Visuals Map for abstract art
      const elementVisuals = {
        'Wood': 'deep forest green organic roots and bamboo silhouettes',
        'Fire': 'dynamic rising red brushstrokes, embers and warm smoke',
        'Earth': 'grounded terracotta textures, stone surfaces and mountain shapes',
        'Metal': 'sharp silver precision lines, geometric gold leaf and minimalism',
        'Water': 'deep blue fluid ink spills, ripples and mysterious mist'
      };

      const visualStyle = elementVisuals[strongest] || "mystical abstract patterns";
      
      // FIX: Remove "keys" (meanings) from the prompt to prevent text rendering.
      // Only use the Card Names which evoke visual archetypes.
      const cardContext = `the archetype of ${c1.n}, the archetype of ${c2.n}, and the archetype of ${c3.n}`;

      const promptText = `Create a purely visual, wordless masterpiece.
      Subject: A surreal, dreamlike landscape representing ${intent}.
      Integrate abstract visual motifs of ${cardContext}.
      Atmosphere: ${visualStyle}.
      Style: Ethereal double exposure, Sumi-e ink wash, golden Kintsugi lines, 8k resolution.
      Negative Constraint: Do not include any text, letters, characters, words, labels, or signage. The image must be completely devoid of writing.`;

      try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${currentKey}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            instances: [{ prompt: promptText }],
            parameters: { sampleCount: 1 }
          })
        });
        
        const data = await response.json();
        
        if (data.error) {
           // Pass the specific error from Google to the catch block
           throw new Error(data.error.message || JSON.stringify(data.error));
        }

        if(data.predictions && data.predictions[0]) {
           const base64 = data.predictions[0].bytesBase64Encoded;
           const src = `data:image/png;base64,${base64}`;
           
           container.classList.remove("hidden");
           img.src = src;
           
           // Scroll to image
           setTimeout(() => container.scrollIntoView({behavior: "smooth"}), 100);
        } else {
           throw new Error("No image generated (Unknown response format)");
        }
      } catch(e) {
        console.error("Art Generation Error:", e);
        
        let msg = "Generation failed.";
        
        // Intelligent Error Parsing with Detailed Output
        if (e.message) {
            // Check for known Google Cloud permission errors
            if (e.message.includes("PERMISSION_DENIED") || e.message.includes("403")) {
                msg = `‚õî API PERMISSION DENIED: ${e.message}`;
            } else if (e.message.includes("INVALID_ARGUMENT") || e.message.includes("400")) {
                msg = `‚õî BAD REQUEST: ${e.message}`;
            } else if (e.message.includes("Failed to fetch")) {
                msg = "Network Blocked. (AdBlocker/Firewall?)";
            } else {
                // Show raw error for debugging
                msg = `Error: ${e.message.substring(0, 100)}...`; 
            }
        }
        
        toast(msg, "error");
      } finally {
        btn.disabled = false;
        btn.innerHTML = `<span>‚ú¶ Generate Spirit Art</span>`;
      }
    }

    // --- RENDERING CHARTS ---
    function renderRadar(){
      const el = document.getElementById("radarChart");
      const size = 280;
      const center = size/2;
      const radius = 100;
      
      const points = ELEMENTS.map((e, i) => {
        const val = state.wuxing[e] || 10; // min clamp
        const norm = Math.min(val, 60) / 60; // normalize somewhat
        const r = radius * norm;
        const angle = (Math.PI * 2 * i) / 5 - Math.PI/2;
        return [
          center + r * Math.cos(angle),
          center + r * Math.sin(angle)
        ];
      });
      
      const polyPoints = points.map(p => p.join(",")).join(" ");
      
      // Create SVG
      let svg = `<svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}">`;
      
      // Grid
      [0.2, 0.4, 0.6, 0.8, 1].forEach(sc => {
        let gridPts = "";
        for(let i=0; i<5; i++){
          const angle = (Math.PI * 2 * i) / 5 - Math.PI/2;
          const r = radius * sc;
          gridPts += `${center + r * Math.cos(angle)},${center + r * Math.sin(angle)} `;
        }
        svg += `<polygon points="${gridPts}" fill="none" stroke="rgba(255,255,255,0.05)" />`;
      });
      
      // Data
      svg += `<polygon points="${polyPoints}" fill="rgba(212,175,55,0.2)" stroke="#d4af37" stroke-width="2" />`;
      
      // Labels
      ELEMENTS.forEach((e, i) => {
        const angle = (Math.PI * 2 * i) / 5 - Math.PI/2;
        const r = radius + 25;
        const x = center + r * Math.cos(angle);
        const y = center + r * Math.sin(angle);
        svg += `<text x="${x}" y="${y}" fill="#888" font-size="10" text-anchor="middle" dominant-baseline="middle">${e}</text>`;
      });
      
      svg += `</svg>`;
      el.innerHTML = svg;
      
      // Legend
      const legend = document.getElementById("elementLegend");
      legend.innerHTML = ELEMENTS.map(e => {
        const rel = getRelation(state.masterElem, e).split("/")[0]; // Short label
        return `<span title="${rel}">${e} <span class="text-gold">${state.wuxing[e].toFixed(0)}%</span></span>`;
      }).join("");
    }

    function renderTrend(){
      const container = document.getElementById("trendChart");
      // Mock trend for visual flair based on daily cycle
      // In a real app, this would calculate hourly strength of Day Master
      let bars = "";
      for(let i=0; i<12; i++){
        const h = 20 + Math.random() * 60;
        bars += `<div class="flex-1 bg-white/5 hover:bg-gold/40 transition-colors rounded-t-sm relative group" style="height:${h}%">
          <div class="absolute bottom-full mb-1 left-1/2 -translate-x-1/2 bg-black text-[9px] px-1 hidden group-hover:block text-gold">${(i*2)%24}h</div>
        </div>`;
      }
      container.innerHTML = bars;
    }

    function renderResults(){
      const roles = ["Mirror", "Key", "Gate"];
      const container = document.getElementById("finalCards");
      container.innerHTML = state.picked.map((c, i) => `
        <div class="panel p-6 rounded-2xl flex flex-col items-center text-center fade-in" style="animation-delay:${i*200}ms">
           <span class="text-[10px] uppercase tracking-[0.2em] text-gray-500 mb-3">${roles[i]}</span>
           <div class="relative w-full max-w-[180px] aspect-[2/3] mb-4 overflow-hidden rounded-lg shadow-2xl border border-white/5 ring-1 ring-gold/20">
             <img src="${c.img}" class="w-full h-full object-cover vintage-filter">
           </div>
           <h3 class="text-gold font-bold font-serif text-lg mb-1">${c.n}</h3>
           <div class="text-xs text-gray-400 uppercase tracking-wider mb-3">${c.key}</div>
           <p class="text-sm text-gray-300 font-light italic leading-relaxed">"${c.zen}"</p>
        </div>
      `).join("");
    }

    // --- AUDIO ---
    function ringBell(vol = 0.2) {
      try {
        const Ctx = window.AudioContext || window.webkitAudioContext;
        if (!Ctx) return;
        const ctx = new Ctx();
        
        // Bell Fundamentals
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        const filter = ctx.createBiquadFilter();
        
        osc.type = "sine";
        osc.frequency.setValueAtTime(520, ctx.currentTime); // C5 ish
        osc.frequency.exponentialRampToValueAtTime(518, ctx.currentTime + 1.5); // Slight detune drop
        
        filter.type = "lowpass";
        filter.frequency.setValueAtTime(2000, ctx.currentTime);
        filter.frequency.linearRampToValueAtTime(300, ctx.currentTime + 1.5);
        
        gain.gain.setValueAtTime(0, ctx.currentTime);
        gain.gain.linearRampToValueAtTime(vol, ctx.currentTime + 0.02);
        gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 3.5);
        
        osc.connect(filter);
        filter.connect(gain);
        gain.connect(ctx.destination);
        
        osc.start();
        osc.stop(ctx.currentTime + 4);
        
        // Upper harmonic shimmer
        const osc2 = ctx.createOscillator();
        const gain2 = ctx.createGain();
        osc2.type = "triangle";
        osc2.frequency.setValueAtTime(1045, ctx.currentTime);
        gain2.gain.setValueAtTime(0, ctx.currentTime);
        gain2.gain.linearRampToValueAtTime(vol * 0.3, ctx.currentTime + 0.02);
        gain2.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 2.5);
        
        osc2.connect(gain2);
        gain2.connect(ctx.destination);
        osc2.start();
        osc2.stop(ctx.currentTime + 3);

        // Visual Trigger
        const halo = document.getElementById("bellHalo");
        if(halo) {
           const ripple = document.createElement("div");
           ripple.className = "ring-wave";
           halo.appendChild(ripple);
           setTimeout(() => ripple.remove(), 1600);
        }

      } catch(e) { console.log("Audio not supported"); }
    }

    // --- BREATH WORK ---
    let breathInterval;
    function startBreath() {
      if(breathInterval) clearInterval(breathInterval);
      
      const phaseEl = document.getElementById("breathPhase");
      const countEl = document.getElementById("breathCount");
      const orb = document.getElementById("breathOrb");
      
      const cycle = [
        { name: "INHALE", time: 4, scale: 1.1, color: "rgba(212,175,55,0.4)" },
        { name: "HOLD", time: 2, scale: 1.1, color: "rgba(212,175,55,0.6)" },
        { name: "EXHALE", time: 6, scale: 0.9, color: "rgba(212,175,55,0.1)" }
      ];
      
      let step = 0;
      let timeLeft = cycle[0].time;
      
      function update() {
        if(timeLeft === cycle[step].time) {
          // Phase start
          phaseEl.innerText = cycle[step].name;
          orb.style.transform = `scale(${cycle[step].scale})`;
          orb.style.borderColor = cycle[step].color;
          orb.style.boxShadow = `0 0 30px ${cycle[step].color}`;
          if(cycle[step].name === "INHALE") ringBell(0.05);
        }
        
        countEl.innerText = timeLeft;
        timeLeft--;
        
        if(timeLeft < 0) {
          step = (step + 1) % 3;
          timeLeft = cycle[step].time;
          update(); // immediate update for next phase
        }
      }
      
      update();
      breathInterval = setInterval(update, 1000);
    }

    function stopBreath() {
      clearInterval(breathInterval);
      document.getElementById("breathPhase").innerText = "READY";
      document.getElementById("breathCount").innerText = "‚Äî";
      const orb = document.getElementById("breathOrb");
      orb.style.transform = "scale(1)";
      orb.style.boxShadow = "none";
      orb.style.borderColor = "rgba(212,175,55,0.2)";
    }
  </script>
</body>
</html>
